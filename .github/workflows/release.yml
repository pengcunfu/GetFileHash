# å‘å¸ƒ - æ„å»ºå¹¶ä¸Šä¼  Release é™„ä»¶
name: Release - å‘å¸ƒç‰ˆæœ¬

# è§¦å‘æ¡ä»¶ï¼šåˆ›å»º Release æ—¶
on:
  release:
    types: [ published ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: å®‰è£… Nuitka
      run: |
        pip install nuitka

    - name: å®‰è£… MSVC æ„å»ºå·¥å…·
      uses: microsoft/setup-msbuild@v1.3

    - name: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        python scripts/deploy.py
      shell: cmd

    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash

    - name: ç”Ÿæˆ Release è¯´æ˜
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # GetFileHash ${{ steps.version.outputs.version }}

        ## åŠŸèƒ½ç‰¹æ€§
        - ğŸ¨ ç°ä»£åŒ–å›¾å½¢ç”¨æˆ·ç•Œé¢
        - ğŸ“Š å¤§æ–‡ä»¶è®¡ç®—è¿›åº¦æ˜¾ç¤º
        - ğŸ“‹ ä¸€é”®å¤åˆ¶å“ˆå¸Œå€¼åˆ°å‰ªè´´æ¿
        - ğŸš€ æ”¯æŒä»»æ„å¤§å°çš„æ–‡ä»¶
        - ğŸ’» è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€Linuxã€macOSï¼‰
        - ğŸ”„ æ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼šMD5ã€SHA-1ã€SHA-256ã€SHA-384ã€SHA-512
        - ğŸ“ æ”¯æŒæ–‡ä»¶å’Œæ–‡æœ¬å“ˆå¸Œè®¡ç®—
        - ğŸ–±ï¸ æ”¯æŒæ–‡ä»¶æ‹–æ‹½æ“ä½œ

        ## ä½¿ç”¨è¯´æ˜
        1. é€‰æ‹©æ–‡ä»¶æˆ–è¾“å…¥æ–‡æœ¬
        2. é€‰æ‹©å“ˆå¸Œç®—æ³•
        3. ç‚¹å‡»è®¡ç®—æŒ‰é’®
        4. å¤åˆ¶è®¡ç®—ç»“æœ

        ## ç³»ç»Ÿè¦æ±‚
        - Windows 7 åŠä»¥ä¸Šç‰ˆæœ¬

        ## æŠ€æœ¯æ ˆ
        - Python 3.9
        - PySide6 (Qt for Python)
        - Nuitka (ç¼–è¯‘å·¥å…·)

        ## è®¸å¯è¯
        MIT License
        EOF

        echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      shell: bash

    - name: æ›´æ–° Release è¯´æ˜
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const notes = fs.readFileSync('release_notes.md', 'utf8');

          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.event.release.id,
            body: notes
          });

    - name: ä¸Šä¼  Windows å¯æ‰§è¡Œæ–‡ä»¶åˆ° Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./dist/GetFileSha.exe
        asset_name: GetFileHash-Windows.exe
        asset_content_type: application/octet-stream