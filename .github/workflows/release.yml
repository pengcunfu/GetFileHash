# 发布 - 构建并上传 Release 附件
name: Release - 发布版本

# 触发条件：推送标签时自动创建 Release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python 环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 安装 Nuitka
      run: |
        pip install nuitka imageio

    - name: 安装 MSVC 构建工具
      uses: microsoft/setup-msbuild@v1.3

    - name: 安装 Inno Setup
      run: |
        choco install innosetup -y
      shell: cmd

    - name: 构建 Windows 可执行文件
      run: |
        python scripts/build.py
      shell: cmd

    - name: 构建安装程序
      run: |
        python scripts/build_installer.py
      shell: cmd

    - name: 获取版本信息
      id: version
      run: |
        echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash

    - name: 生成 Release 说明
      run: |
        # 使用模板文件生成 Release 说明
        sed "s/{VERSION}/${{ steps.version.outputs.version }}/g" .github/RELEASE_TEMPLATE.md > release_notes.md
      shell: bash

    - name: 压缩应用程序
      run: |
        cd ./dist/main.dist
        7z a -tzip ../GetFileHash-${{ steps.version.outputs.version }}.zip ./
      shell: bash

    - name: 创建 Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: GetFileHash ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./dist/GetFileHash-${{ steps.version.outputs.version }}.zip
          ./installer/GetFileHash-Setup-*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}